## Introduction 
This repository houses an overlay filesystem that runs in userspace using [libfuse](https://github.com/libfuse/libfuse/tree/master).
## Motivation
The motivation for creating a baby overlay filesystem came from exploring the implementation of Docker. 

Docker is cool because it, to a great extent, solves the dependency hell problem. Modern applications are beasts, relying on a dizzying array of dependencies to perform the barest of tasks(the npm package *is-even* comes to mind). The same abstractions that let us do more - fast, also pose one of the biggest challenges when you try to run several of them on the same machine. Docker, learning from all the operating systems that came before it, solves this by playing *illusionist* - to each Docker container the only thing on the machine are just what it needs - no more, no less. 

Sounds cool right? Hard to do well.
Just the vision is easy enough to achieve - put all the dependencies a container needs in a directory and run it in that directory - hiding everything else from it. This sounds nice until you try to run a few 1000 applications, whence including a full 100 MB Java runtime environment suddenly means that you need 100 GB of disk space just for storing the dependencies. 

It's easy to see where this is wasteful, and the obvious next idea is to centralize common dependencies together and then try to provide to each application the illusion that it has its own copy of that dependency. The name of this illusion is an overlay filesystem.

## Overlay filesystems
An overlay filesystem works as follows: given two distinct directories *lowerdir* and *upperdir*, it tries to present to the user a unified view of these two directories.

Historically this was used to "write" to a read-only CD. You'd create a writable layer above it, where all your chages went - leaving the disk untouched. 
For us Docker enthusiasts, it will be used to present the illusion that you have an editable copy of a dependency on which you can write, while keeping the actual copy spotless.
<img width="1513" height="571" alt="image" src="https://github.com/user-attachments/assets/3557b663-0829-4610-a5ee-358ec9cf400b" />


## Overlay filesystems in user space

The *lowerdir* and *upperdir* don't really comprise real storage media - they are directories on our disk. Therefore, our filesystem can run in user mode without the kernel actually having to manage any real storage.

We achieve this is by registering with the virtual filesystem, a *daemon* - a long running background process that roleplays as a filesystem - answering any queries that the OS makes of the virtual filesystem. 

This daemon(with the help of libfuse - a simple C program) is responsible for managing the actual backing directories and presenting the unified view to the OS, according to the semantics of the overlay filesystem.
To write a filesystem means to write this program. 


## The systemcalls and their semantics
One of the design principles behind UNIX was that files are the lingua franca of programs - files are how programs communicate with each other. Unsurprisingly, thus, writing a filesystem is a great way to learn how UNIX-like systems work. 

The OS exposes functionality to the user via what is called *systemcalls*(or *syscalls* for short), callable through shell or from programming language APIs. Some of the most commonly used UNIX tools like ls, cat, echo or vim work by composing a few syscalls. You can see this in action by running the same commands inside of an strace - which shows exactly what syscalls were made. 

Our job as filesystem author is to help the OS answer syscalls. Libfuse handles the interaction with the virtual filesystem and so all we need to provide is a set of functions called FUSE callbacks that describe how the filesystem works.

The following table summarizes some typical syscalls, the associated FUSE callback and the semantics by which the two directories are combined to present the unified view.
There are two recurring themes in the union semantics. 
1. Whiteouts: We provide delete functionality in the immutable lowerdir by creating a corresponding *gravestone* in upperdir, called a whiteout. For a file or directory with path *f* relative to lowerdir, this gravestone is a file with path *f.wh* relative to upperdir. 
2. Copy-up: We provide edit functionality in the immutable lowerdir by creating a copy of whichever file in lowerdir is desired to be edited, whenever the OS is asked to open a file in a write mode.

| FUSE Callback | System Call | Description                                                                                                                                                                       | Union Semantics                                                                                                                                                                                                                                                                                                                               |
|---------------|-------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| getattr       | getxattr    | Returns attributes(key-value pairs) associated with a given path in a filesystem                                                                                                  | For a file that exists only in lowerdir, return the attributes of that file unless the file has a corresponding whiteout entry in the upperdir. If the file exists in the upperdir, then return the attributes of the upperdir - shading the copy of the file in the lowerdir altogether.                                                     |
| readdir       | readdir     | Reads a directory, returning a list of all the entries(directories or files) in it                                                                                                | All files in the upperdir should be returned, files in the lowerdir should be returned only if there is no file of the same name or a whiteout entry corresponding to that file in the upperdir.                                                                                                                                              |
| open          | open        | Open a file, creating an entry in the open file table with the file metadata, and return a file descriptor to the user that they can use to refer to that file                    | If the file has not been whited out in the upperdir and there is an upperdir entry, open it. If the file exists only in the lowerdir and is trying to be opened in a write mode, then we copy up the file to the upperdir and open the upperdir copy. Otherwise if it is only opened in read mode, open the lowerdir file without copying-up. |
| create        | creat       | Old syscall for POSIX backwards compatibility, creates a file(truncating to zero if it already exists) and returns a file descriptor to it, having opened it in a write-only mode | Create and open the file in the upperdir                                                                                                                                                                                                                                                                                                      |
| release       | close       | Closes a file descriptor                                                                                                                                                          | Close the file descriptor                                                                                                                                                                                                                                                                                                                     |
| rmdir         | rmdir       | Removes an empty directory                                                                                                                                                        | If the directory exists in the lowerdir, create a whiteout file for the directory. If the directory exists in upperdir, delete it entirely.                                                                                                                                                                                                   |
| unlink        | unlink      | Removes a file                                                                                                                                                                    | If the file exists in upperdir, delete it. If it exists in lowerdir, create a whiteout file for it.                                                                                                                                                                                                                                           |
| read          | read        | Read bytes from a file descriptor                                                                                                                                                 | If there specified file exists in the upperdir, read from it, otherwise if it only exists in the lowerdir, read from it unless it has been whited out.                                                                                                                                                                                        |
| write         | write       | Write to a file descriptor                                                                                                                                                        | Write to the specified file descriptor.                                                                                                                                                                                                                                                                                                       |
| mkdir         | mkdir       | Create a new directory                                                                                                                                                            | Create a new directory in upperdir, unless the specified path is already taken by either an upperdir or lowerdir path.                                                                                                                                                                                                                        |
| truncate      | truncate    | Truncate a given file to a certain size in bytes, this can involve padding the file if the provided size is larger than the actual size or truncating it at the end otherwise.    | If the file is in upperdir truncate it. If the file is only in the lowerdir and has not been whited out, then make a copy of it in upperdir and truncate that copy.                                                                                                                                                                           |
| rename        | rename      | Change the name or location of a file                                                                                                                                             | Renaming is always done in upperdir, using whiteouts and copy-ups to ensure overlay correctness.                                                                                                                                                                                                                                              |
